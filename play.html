<!doctype html>
<html>
  <head>
    <title>starship - playing a game</title>
    <link rel="icon" type="image/x-icon" href="/uploads/branding/favicon.png" />
    <meta
      name="description"
      content="Play games, level up, and explore Starship - your new favorite gaming site."
    />
    <link rel="canonical" href="https://starship-app.com/play" />
    <link rel="stylesheet" href="/css/viewers.css" />
    <link rel="stylesheet" href="/css/navbar.css" />
    <link rel="stylesheet" href="/css/menu.css" />
    <link rel="stylesheet" href="/css/main.css" />
    <script src="/javascript/menu.js"></script>
    
    <!-- Google AdSense and Google Analytics -->

    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4851718454212779"
      crossorigin="anonymous"
    ></script>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-ZZH4JE7RJF"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', 'G-ZZH4JE7RJF');
    </script>
    <style>
      body {
        background-color: black;
        animation: fadeInBackground 2s ease-in-out forwards;
        overflow: auto;
        font-family:
          Space Grotesk,
          sans-serif;
      }

      @keyframes fadeInBackground {
        from {
          background-color: black;
        }
        to {
          background-color: black;
        }
      }

      @keyframes scaleAndSlideUp {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      iframe {
        background-color: black;
        opacity: 0;
        transform: scale(0.9) translateY(20px);
        animation: scaleAndSlideUp 1s ease-in-out forwards;
      }

      #navbar {
        opacity: 0;
        transform: scale(0.9) translateY(-30px);
        animation: scaleAndSlideUp 1s ease-in-out forwards;
      }

      .controls {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
        animation: scaleAndSlideUp 1s ease-in-out 1.5s forwards;
      }

      .buttons button {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
        animation: scaleAndSlideUp 0.5s ease-in-out forwards;
      }

      #randomGameContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
      }

      .game {
        flex: 0 1 150px;
        text-align: center;
        color: white;
        margin: 5px;
      }

      * {
        scrollbar-width: none !important;
      }

      *::-webkit-scrollbar {
        display: none !important;
      }
      #myIframe {
  transition: opacity 0.5s ease;
}

    </style>
  </head>
  <body>
    <div id="navbar"></div>
    <script type="module" src="/javascript/navbar.js"></script>
    <div class="game-container">
      <iframe id="myIframe" src="" allowfullscreen name="myIframe"></iframe>
      <!-- Like Ratio Bar -->
      <div id="likeRatioBar" title="No votes yet">
        <div id="likeRatioLike"></div>
        <div id="likeRatioDislike"></div>
      </div>
      <div class="controls">
        <div class="game-info">
          <div class="game-details">
            <img src="" alt="Game Icon" class="game-img" />
            <h2 class="gradient-red">Game Title</h2>
          </div>
          <div class="buttons">
            <p style="margin-left: 10px; font-size: 18px">
              Game data is being saved to your computer
            </p>
          </div>
        </div>
      </div>
      <div class="description-container">
        <p id="gameDescText">Loading game description...</p>
      </div>
    </div>
    <!-- Share Popup -->
    <div
      id="sharePopup"
      style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #181818;
          color: white;
          border-radius: 16px;
          padding: 32px 24px;
          min-width: 320px;
          max-width: 90vw;
          box-shadow: 0 4px 32px #000a;
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span
            id="shareGameTitle"
            style="font-size: 1.2em; font-weight: bold"
          ></span>
          <button
            id="closeSharePopup"
            style="
              background: none;
              border: none;
              color: white;
              font-size: 1.5em;
              cursor: pointer;
            "
          >
            √ó
          </button>
        </div>
        <div style="margin: 18px 0 10px 0; text-align: center">
          <span>You're about to share "<span id="shareGameName"></span>"</span>
        </div>
        <div
          style="
            display: flex;
            gap: 24px;
            justify-content: center;
            margin: 18px 0;
          "
        >
          <button
            id="copyShareLink"
            title="Copy to clipboard"
            style="
              background: none;
              border: none;
              color: white;
              font-size: 2em;
              cursor: pointer;
            "
          ></button>
          <button
            id="mailShareLink"
            title="Share via Email"
            style="
              background: none;
              border: none;
              color: white;
              font-size: 2em;
              cursor: pointer;
            "
          ></button>
        </div>
        <div
          style="
            font-size: 0.95em;
            color: #aaa;
            text-align: center;
            margin-top: 10px;
          "
        >
          sharing via stardrop
        </div>
        <div
          id="sharePopupMsg"
          style="
            font-size: 0.95em;
            color: #7fff7f;
            text-align: center;
            margin-top: 10px;
            display: none;
          "
        ></div>
      </div>
    </div>

<div id="blurWarning" style="
  display: none;
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 69, 0, 0.95);
  color: white;
  padding: 20px 28px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.7);
  z-index: 10000;
  font-family: 'Space Grotesk', sans-serif;
  max-width: 90vw;
  text-align: center;
  cursor: pointer;
  user-select: none;
  font-size: 1.1rem;
">
  <h1 style="margin: 0 0 8px; font-weight: 700; font-size: 1.8rem;">‚ö†Ô∏è Heads up!</h1>
  <p style="margin: 0 0 8px;">
    This game may contain scary or disturbing visuals.<br />
    We don‚Äôt allow games with inappropriate content, but this one might be intense for some.
  </p>
  <a href="/games"><button>Go back</button></a><br>
  <small style="opacity: 0.8;">Click here to dismiss</small>
</div>


    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

<script>
// filepath: c:\Users\ryanl\Desktop\starship.assets\starship-site.github.io\play.html
// Fix: Use window.supabase.createClient for UMD, and DO NOT use type="module" for this script!

const { createClient } = window.supabase;

const supabase = createClient(
  'https://jbekjmsruiadbhaydlbt.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpiZWtqbXNydWlhZGJoYXlkbGJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzOTQ2NTgsImV4cCI6MjA2Mzk3MDY1OH0.5Oku6Ug-UH2voQhLFGNt9a_4wJQlAHRaFwTeQRyjTSY'
);


let redirectTimeout;
let gameId = null;      // Global so we can use it for likes/dislikes
let currentUserId = null; // Global so we can clear the game on unload

function redirectIframe(link, name) {
  console.log('‚è≥ Redirecting iframe...');

  const iframe = document.getElementById('myIframe');
  const loaderPage = '/storage/loading.html';

  const gameInfo = document.querySelector('.game-info h2');
  const gameImage = document.querySelector('.game-info img');
  const savedImage = localStorage.getItem('gameImage');

  clearTimeout(redirectTimeout);
  iframe.style.opacity = '0';
  iframe.src = loaderPage;

  iframe.onload = () => {
    console.log('üé¨ Loader loaded');
    iframe.style.opacity = '1';
  };

  gameInfo.textContent = name;
  if (savedImage) {
    gameImage.src = savedImage;
    gameImage.alt = name;
  }

  redirectTimeout = setTimeout(() => {
    console.log('üöÄ Loading game:', link);
    iframe.style.opacity = '0';
    iframe.onload = null;

    iframe.addEventListener('load', function onGameLoad() {
      console.log('üéÆ Game loaded');
      iframe.style.opacity = '1';
      iframe.removeEventListener('load', onGameLoad);
    });

    iframe.src = link;
  }, 4000);
}

window.addEventListener('load', async () => {
  console.log('üì¶ Window loaded');
  const gameLink = localStorage.getItem('gameLink');
  const gameName = localStorage.getItem('gameName');

  if (gameLink && gameName) {
    redirectIframe(gameLink, gameName);
  }




  // Get logged-in user for later
  const { data: { user } } = await supabase.auth.getUser();
  if (user) currentUserId = user.id;

  // Fetch game and update UI
  async function fetchAndShowGame() {
    if (!gameLink) return;
    const { data: game, error } = await supabase
      .from('games_menu')
      .select('id, name, description, img_url, url')
      .eq('url', gameLink)
      .maybeSingle();

    if (error || !game) return;

    gameId = game.id; // Save ID for likes/dislikes
    document.querySelector('.game-info h2').textContent = game.name;
    document.querySelector('.game-info img').src = game.img_url || '/uploads/default-game-icon.png';
    document.getElementById('gameDescText').textContent = game.description || 'No description available.';
    localStorage.setItem('gameImage', game.img_url || '');

    if (user) {
      const { error: updateError } = await supabase
        .from('profiles')
        .update({ current_game_id: game.id })
        .eq('id', user.id);
      if (!updateError) console.log('‚úÖ current_game_id updated to:', game.id);
    }
  }

  // Increment play count
  async function incrementPlayCount() {
    if (!gameLink) return;
    const { data: row } = await supabase.from('games_menu').select('id').eq('url', gameLink).maybeSingle();
    if (row) {
      gameId = row.id;
      await supabase.rpc('increment_play_count_int', { gid: gameId });
      console.log('‚úÖ play_count incremented');
    }
  }

  // Clear current game when leaving
  function clearCurrentGame() {
    if (!currentUserId) return;
    navigator.sendBeacon(
      'https://jbekjmsruiadbhaydlbt.supabase.co/functions/v1/clear-current-game',
      JSON.stringify({ user_id: currentUserId })
    );
    console.log('üì§ Cleared current game for user', currentUserId);
  }

  window.addEventListener('beforeunload', clearCurrentGame);
  window.addEventListener('pagehide', clearCurrentGame);
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') clearCurrentGame();
  });

  await fetchAndShowGame();
  await incrementPlayCount();
});
// --- Like/Dislike System (Fixed) ---
function initLikeDislikeSystem() {
  const likeBtn = document.getElementById('likeBtn');
  const dislikeBtn = document.getElementById('dislikeBtn');
  const likeCount = document.getElementById('likeCount');
  const dislikeCount = document.getElementById('dislikeCount');

  if (!likeBtn || !dislikeBtn || !likeCount || !dislikeCount || !gameId) {
    console.log("‚è≥ Navbar or gameId not ready yet...");
    return false; // Try again later
  }

  console.log("‚úÖ Found like/dislike buttons. Initializing.");

  const likeKey = `liked_${gameId}`;
  const dislikeKey = `disliked_${gameId}`;

  function updateButtonStates() {
    const liked = !!localStorage.getItem(likeKey);
    const disliked = !!localStorage.getItem(dislikeKey);

    likeBtn.disabled = false;
    dislikeBtn.disabled = false;
    if (liked) dislikeBtn.disabled = true;
    if (disliked) likeBtn.disabled = true;

    likeBtn.classList.toggle('active', liked);
    dislikeBtn.classList.toggle('active', disliked);

    likeBtn.innerHTML = liked
      ? '<i class="fa-solid fa-thumbs-up fa-lg"></i> <span class="link-text">Like</span>'
      : '<i class="fa-regular fa-thumbs-up fa-lg"></i> <span class="link-text">Like</span>';
    dislikeBtn.innerHTML = disliked
      ? '<i class="fa-solid fa-thumbs-down fa-lg"></i> <span class="link-text">Dislike</span>'
      : '<i class="fa-regular fa-thumbs-down fa-lg"></i> <span class="link-text">Dislike</span>';
  }
function updateLikeRatioBar(likes, dislikes) {
  const bar = document.getElementById('likeRatioBar');
  const likeDiv = document.getElementById('likeRatioLike');
  const dislikeDiv = document.getElementById('likeRatioDislike');

  const total = likes + dislikes;
  const likePercent = total > 0 ? (likes / total) * 100 : 0;
  const dislikePercent = total > 0 ? (dislikes / total) * 100 : 0;

  likeDiv.style.width = likePercent + '%';
  dislikeDiv.style.width = dislikePercent + '%';

  // Optional: color the bar segments
  likeDiv.style.background = '#4caf50';  // green for likes
  dislikeDiv.style.background = '#f44336';  // red for dislikes

  bar.title = `${likes} Likes / ${dislikes} Dislikes`;
}

  async function loadVotes() {
    console.log('üìä Loading vote counts...');

    const { data: row, error } = await supabase
      .from('games_menu')
      .select('likes, dislikes')
      .eq('id', gameId)
      .maybeSingle();

    if (error || !row) {
      likeCount.textContent = '0';
      dislikeCount.textContent = '0';
      console.error('‚ùå Failed to fetch votes:', error);
      return;
    }

    const likes = row.likes || 0;
    const dislikes = row.dislikes || 0;
    likeCount.textContent = likes;
    dislikeCount.textContent = dislikes;

    updateButtonStates();
    updateLikeRatioBar(likes, dislikes);
  }

  likeBtn.addEventListener('click', async () => {
    const liked = !!localStorage.getItem(likeKey);
    const disliked = !!localStorage.getItem(dislikeKey);

    if (liked) {
      await supabase.rpc('increment_likes', { gid: gameId, delta: -1 });
      localStorage.removeItem(likeKey);
    } else if (!disliked) {
      await supabase.rpc('increment_likes', { gid: gameId, delta: 1 });
      localStorage.setItem(likeKey, '1');
      localStorage.removeItem(dislikeKey);
    }

    updateButtonStates();
    loadVotes();
  });

  dislikeBtn.addEventListener('click', async () => {
    const liked = !!localStorage.getItem(likeKey);
    const disliked = !!localStorage.getItem(dislikeKey);

    if (disliked) {
      await supabase.rpc('increment_dislikes', { gid: gameId, delta: -1 });
      localStorage.removeItem(dislikeKey);
    } else if (!liked) {
      await supabase.rpc('increment_dislikes', { gid: gameId, delta: 1 });
      localStorage.setItem(dislikeKey, '1');
      localStorage.removeItem(likeKey);
    }

    updateButtonStates();
    loadVotes();
  });

  loadVotes(); // initial load
  return true; // done, stop polling
}

// Keep retrying every 200ms until navbar and gameId are ready
const waitForNavbar = setInterval(() => {
  if (initLikeDislikeSystem()) clearInterval(waitForNavbar);
}, 200);

  const blurWarning = document.getElementById('blurWarning');

  console.log('üö¶ DOM loaded, checking blur warning');

  const blurSetting = localStorage.getItem('blur');
  console.log('üì¶ localStorage blur value:', blurSetting);

  // Show warning every time, ignore dismissal for now
  if (blurSetting === 'true') {
    console.log('‚ö†Ô∏è Blur setting is true, showing warning');
    blurWarning.style.display = 'block';
  } else {
    console.log('‚ÑπÔ∏è Blur setting is false or missing, not showing warning');
  }

  blurWarning.addEventListener('click', () => {
    console.log('üõë Blur warning dismissed by user');
    blurWarning.style.display = 'none';
    // Commenting out dismissal storage so it always shows
    // localStorage.setItem('blurWarningDismissed', 'yes');
  });
  console.log('‚úÖ Blur warning setup complete');


</script>

    <!-- Particles.JS -->
    <div id="particles-js"></div>
    <script src="/javascript/particles.js"></script>
    <script src="/javascript/particles-config.js"></script>
    <script src="/javascript/panic.js" type="module"></script>
    <script src="/javascript/cloaking.js" type="module"></script>
    <script type="module" src="/javascript/notifications.js"></script>
    <script src="/javascript/antitabclose.js"></script>
    <script src="/javascript/screentimetracking.js" type="module"></script>
    <!-- Scheduler -->

    <script src="/javascript/schedule.js"></script>
  </body>
</html>
